<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>666 representation</title>

	<!--<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>-->
	<!--<script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>-->
	
</head>

<body>
	<main id=main" class="cmath">
		$$ 600+66=666 $$
	</main>
</body>

<script>

// http://127.0.0.1:5500/index.html?&num=666&seed=0

var urlsp = new URLSearchParams(window.location.href)
var num = urlsp.get('num')
var seed = urlsp.get('seed')

MathJax = {
	tex: {
		inlineMath: [['$', '$'], ['\\(', '\\)']]
	},
	svg: {
		fontCache: 'global'
	}
};

function rand_int(minimum, maximum, exclude=[]) {
	// var p, ok
	// do {
	// 	p = Math.floor(Math.random() * (maximum - minimum + 1)) + minimum
	// 	ok = exclude.includes(p)
	// } while (!ok);

	console.log(minimum, maximum, exclude)

	// exclude.sort(function(a, b){return a - b})
	for (var i=0; i < exclude.length; i++) {
		if (exclude.includes(minimum+1)) { 
			minimum++; 
			exclude = exclude.filter(e => e <= minimum) 
		}
		if (exclude.includes(maximum-1)) { 
			maximum--; 
			exclude = exclude.filter(e => e >= maximum) 
		}
	}

	if (maximum - minimum < 0) {console.log('aaa'); return null}
	
	var p = Math.floor(Math.random() * (maximum - minimum + 1)) + minimum
	if (exclude.includes(p)) return rand_int(minimum, maximum, exclude)
	
	return p
}

function expand_expression(number, depth_rate=0.5, prob=1, prev=-1) {
	var res_str = ''

	var count = 3
	var excl = []
	if (prob == 1) excl.push(1)
	if (prev == 3) excl.push(3)
	
	if (excl.length == count) return number
	
	var t = rand_int(1, count, excl)
	
	console.log(number, t)
	
	if (t == 1) {
		res_str = number
	}
	else if (t == 2) {
		var a = rand_int(0, Math.abs(number)*2, [number]) - number
		var b = number - a

		res_str += expand_expression(a, depth_rate, prob*depth_rate, prev=t)
		res_str += '+'
		res_str += expand_expression(b, depth_rate, prob*depth_rate, prev=t)
	}
	else if (t == 3) {
		var b = rand_int(2, 13)
		var a = number * b

		res_str += '\\frac{'
		res_str += expand_expression(a, depth_rate, prob*depth_rate, prev=t)
		res_str += '}{'
		res_str += expand_expression(b, depth_rate, prob*depth_rate, prev=t)
		res_str += '}'
	}
	
	// return res_str
	return '(' + res_str + ')'
}

let promise = Promise.resolve();
function typeset(code) {
  promise = promise.then(() => MathJax.typesetPromise(code()))
                   .catch((err) => console.log('Typeset failed: ' + err.message));
  return promise;
}

var expr = expand_expression(num)

typeset(() => {
	const math = document.querySelector('main');
	console.log(expr)
	math.innerHTML = '$$' + expr + '=' + num + '$$';
	return [math];
});

</script>

<script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

<style>

main {
	position: absolute;
	left: 50%;
	top: 50%;
	transform: translate(-50%, -50%);
	font-size: 3vmin;
}

</style>

</html>